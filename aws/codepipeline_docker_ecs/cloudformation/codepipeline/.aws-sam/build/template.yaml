AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: CodePipeline sample
Parameters:
  PipeLineName:
    Type: String
    Description: Specifies the ECS Cluster Name with which the resources would be
      associated.
    Default: cp-ecs2
  SourceRepository:
    Type: String
    Description: Specifies a GitHub repository to use as the source repository.
    Default: efarish/portfolio
Resources:
  CodePipeLineECSRole:
    Type: AWS::IAM::Role
    Properties:
      Description: IAM role used by CodePipeline for the ECS deploys.
      AssumeRolePolicyDocument:
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - codepipeline.amazonaws.com
            - codebuild.amazonaws.com
            - ecs-tasks.amazonaws.com
          Action:
          - sts:AssumeRole
          Condition:
            StringEquals:
              aws:SourceAccount:
                Ref: AWS::AccountId
      Policies:
      - PolicyName:
          Fn::Sub: ${PipeLineName}-policy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - codestar-connections:UseConnection
            - codebuild:BatchGetBuilds
            - codebuild:StartBuild
            - codebuild:BatchGetBuildBatches
            - codebuild:StartBuildBatch
            - cloudwatch:*
            - s3:*
            - ecs:*
            - ecr:*
            - logs:*
            Resource:
            - '*'
      Path: /
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/AWSCodePipeline_FullAccess
  S3Bucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Delete
    Properties:
      BucketName:
        Fn::Sub: ${PipeLineName}-${AWS::Region}-${AWS::AccountId}
  CodeBuildProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Name:
        Fn::Sub: ${PipeLineName}-build
      ServiceRole:
        Fn::GetAtt:
        - CodePipeLineECSRole
        - Arn
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        Type: LINUX_CONTAINER
        ComputeType: BUILD_GENERAL1_SMALL
        Image: aws/codebuild/standard:7.0
        EnvironmentVariables:
        - Name: AWS_ACCT
          Value:
            Fn::Sub: ${AWS::AccountId}
        PrivilegedMode: true
        ImagePullCredentialsType: CODEBUILD
      TimeoutInMinutes: 5
      QueuedTimeoutInMinutes: 10
      LogsConfig:
        CloudWatchLogs:
          Status: ENABLED
        S3Logs:
          Status: DISABLED
          EncryptionDisabled: false
      Visibility: PRIVATE
      Source:
        Type: CODEPIPELINE
        BuildSpec: ./aws/codepipeline_docker_ecs/buildspec.yml
        InsecureSsl: false
  CodePipeline1:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      RoleArn:
        Fn::GetAtt:
        - CodePipeLineECSRole
        - Arn
      ArtifactStore:
        Type: S3
        Location:
          Fn::Sub: ${PipeLineName}-${AWS::Region}-${AWS::AccountId}
      Stages:
      - Name: Source
        Actions:
        - Name: Source
          ActionTypeId:
            Category: Source
            Owner: AWS
            Provider: CodeStarSourceConnection
            Version: '1'
          RunOrder: 1
          Configuration:
            BranchName: main
            ConnectionArn: arn:aws:codeconnections:us-east-1:598185244415:connection/b45ca0fd-e734-4895-a0d2-42e802be757c
            DetectChanges: 'false'
            FullRepositoryId:
              Ref: SourceRepository
            OutputArtifactFormat: CODE_ZIP
          OutputArtifacts:
          - Name: SourceArtifact
          Region:
            Ref: AWS::Region
          Namespace: SourceVariables
      - Name: Build
        Actions:
        - Name: Build
          ActionTypeId:
            Category: Build
            Owner: AWS
            Provider: CodeBuild
            Version: '1'
          RunOrder: 1
          Configuration:
            ProjectName:
              Fn::Sub: ${PipeLineName}-build
          OutputArtifacts:
          - Name: BuildArtifact
          InputArtifacts:
          - Name: SourceArtifact
          Region:
            Ref: AWS::Region
          Namespace: BuildVariables
